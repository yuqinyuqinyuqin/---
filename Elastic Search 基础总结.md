Elastic Search 基础总结

作用

- 一个分布式的实时文档存储，*每个字段* 可以被索引与搜索
- 一个分布式实时分析搜索引擎
- 能胜任上百个服务节点的扩展，并支持 PB 级别的结构化或者非结构化数据

基础概念

- 文档：序列化为包含键值对的 JSON 对象，指定了唯一 ID，概念同 对象。
- *索引* ：存储数据到 Elasticsearch 的行为
- 文档元数据：_index文档在哪存放，_type文档表示的对象类别，_id文档唯一标识    _index手机-_type苹果
- *索引* —— 存储和使文档可被搜索

- 可以提供自定义的 _id 值，或者让 index API 自动生成。

- 检索出文档： HTTP 谓词更改为 GET

-  GET 请求会返回整个文档，这个文档正如存储在 _source 字段中的一样。但是也许你只对其中的 title 字段感兴趣。单个字段能用 _source 参数请求得到，多个字段也能使用逗号分隔的列表来指定。

GET /website/blog/123?_source=title,text

创建，检索，更新和删除文档

- 在 Elasticsearch 中， *每个字段的所有数据* 都是 *默认被索引的* 。 即每个字段都有为了快速检索设置的专用倒排索引。而且，不像其他多数的数据库，它能在 *同一个查询中* 使用所有这些倒排索引，并以惊人的速度返回结果。

1. 索引文档：存储文档和使文档可被搜索。 但是首先要确定文档的位置

- 当我们索引一个文档，怎么确认我们正在创建一个完全新的文档，而不是覆盖现有的呢？_index 、 _type 和 _id 的组合可以唯一标识一个文档。所以，确保创建一个新文档的最简单办法是，使用索引请求的 POST 形式让 Elasticsearch 自动生成唯一 _id

- PUT /megacorp(索引）/employee(类型)/1{

-   "first_name" : "John",

-   "last_name" :  "Smith",

-   "age" :     25,

-   "about" :    "I love to go rock climbing",

-   "interests": [ "sports", "music" ]}

- 没有指定任何查询的空搜索，它简单地返回集群中所有索引下的所有文档

1. 检索文档

-  一个 HTTP GET 请求并指定文档的地址——索引库、类型和ID。 使用这三个信息可以返回原始的 JSON 文档。单个字段能用 _source 参数请求得到，多个字段也能使用逗号分隔的列表来指定。

1. 更新整个文档

- 在 Elasticsearch 中文档是 *不可改变* 的，不能修改它们。相反，如果想要更新现有的文档，需要 *重建索引* 或者进行替换， 我们可以使用相同的 index API 进行实现

1. 处理冲突

- 在数据库领域中，有两种方法通常被用来确保并发更新时变更不会丢失：
- *悲观并发控制*：这种方法被关系型数据库广泛使用，它假定有变更冲突可能发生，因此阻塞访问资源以防止冲突。 一个典型的例子是读取一行数据之前先将其锁住，确保只有放置锁的线程能够对这行数据进行修改。
- *乐观并发控制*：Elasticsearch 中使用的这种方法假定冲突是不可能发生的，并且不会阻塞正在尝试的操作。 然而，如果源数据在读写当中被修改，更新将会失败。应用程序接下来将决定该如何解决冲突。 例如，可以重试更新、使用新的数据、或者将相关情况报告给用户。

1. *乐观并发控制*

- Elasticsearch 是分布式的。当文档创建、更新或删除时， 新版本的文档必须复制到集群中的其他节点。Elasticsearch 也是异步和并发的，这意味着这些复制请求被并行发送，并且到达目的地时也许 *顺序是乱的* 。 Elasticsearch 需要一种方法确保文档的旧版本不会覆盖新的版本。

- 当我们之前讨论 index ， GET 和 delete 请求时，我们指出每个文档都有一个 _version （版本）号，当文档被修改时版本号递增。 Elasticsearch 使用这个 _version 号来确保变更以正确顺序得到执行。

搜索

可以做到：

- 在类似于 gender 或者 age 这样的字段上使用结构化查询，join_date 这样的字段上使用排序，就像SQL的结构化查询一样。
- 全文检索，找出所有匹配关键字的文档并按照_相关性（relevance）_ 排序后返回结果。
- 以上二者兼而有之。

*映射（Mapping）*描述数据在每个字段内如何存储

*分析（Analysis）*全文是如何处理使之可以被搜索的

*领域特定查询语言（Query DSL）*Elasticsearch 中强大灵活的查询语言

1.  空搜索

- 没有指定任何查询的空搜索，它简单地返回集群中所有索引下的所有文档：

1. 轻量搜索

- 一种是 “轻量的” *查询字符串* 版本，要求在查询字符串中传递所有的参数，另一种是更完整的 *请求体* 版本，要求使用 JSON 格式和更丰富的查询表达式作为搜索语言。

  GET /megacorp/employee/_search?q=last_name:Smith

1. 全文搜索：按照相关性降序 返回文档

 match 查询在`about` 属性上搜索 “rock climbing” 

1. 短语搜索

出一个属性中的独立单词是没有问题的，但有时候想要精确匹配一系列单词或者_短语_  match_phrase

1. 多索引，所类型

- 如果不对某一特殊的索引或者类型做限制，就会搜索集群中的所有文档。Elasticsearch 转发搜索请求到每一个主分片或者副本分片，汇集查询出的前10个结果，并且返回给我们。

- 然而，经常的情况下，你想在一个或多个特殊的索引并且在一个或者多个特殊的类型中进行搜索。我们可以通过在URL中指定特殊的索引和类型达到这种效果

![img](https://netease-we.feishu.cn/space/api/box/stream/download/asynccode/?code=fff69b01e8621b4eec4e7e88867a5374_8f118824ce50c961_boxcnUgr8ZMSrRXe4WEQrPe4iTg_Ts1tZqafAX6Qf0CVW38bugXzgeYrHOyk)

Elasticsearch 在分布式环境中的运行原理

真正的扩容能力是来自于水平扩容—为集群添加更多的节点，并且将负载压力和稳定性分散到这些节点中。对于大多数的数据库而言，通常需要对应用程序进行非常大的改动，才能利用上横向扩容的新增资源。 与之相反的是，ElastiSearch天生就是 *分布式的* ，它知道如何通过管理多节点来提高扩容性和可用性。 这也意味着你的应用无需关注这个问题。